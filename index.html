<!DOCTYPE html>
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>Game</title>
	<link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
	<div class="container">

		<div class="row">
			<div class="col-md-2 col-md-offset-1" id="title">
					<h1>Blob</h1>
			</div>

			<div>
				<div class="col-md-1 col-md-offset-5">
					<h2><span class="label label-block label-primary" id="best"> Best <br> 15</span></h2>
				</div>
				<div class="col-md-1">
					<h2><span class="label label-block label-primary" id="score"> Score <br> 100 </span></h2>
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-md-2 col-md-offset-8">
				<center>
					<button class="btn btn-large btn-inverse" type="button" id="newGame"> New Game</button>
				</center>
			</div>
		</div>
		<br>
		
		<div class="row">
			<div class="col-md-8 col-md-offset-1" id="game"> 
			</div>
		</div>
		<br>
	</div>
</body>

<script type="text/javascript" src="js/phaser.js"></script>
<script  src="js/jquery.js"></script>

<script>

var game = new Phaser.Game(880, 600, Phaser.AUTO, 'game', { preload: preload, create: create, update: update });

var blobs;
var bigText;
var bigStyle;
var timer;
var timerText;
var smallStyle;
var cSec;

function preload() {
	game.load.image('blob', 'sprite.png');
}


function create() {
	timer = game.time.create(false);
	timer.loop(100, updateTime, this);
	cSec=0;
	timer.start();

	blobs= game.add.group();
	game.physics.startSystem(Phaser.Physics.ARCADE);

	//creating the initial blob
	var blob = blobs.create(game.world.centerX,game.world.centerX,'blob');
	blob.anchor.setTo(.5,null);
	blob.anchor.set(0.5);
	blob.inputEnabled= true;
	blob.events.onInputDown.add(listener, this);
	game.physics.enable(blob, Phaser.Physics.ARCADE);
	blob.body.velocity.setTo(50,50);
	blob.body.collideWorldBounds=true;
	blob.body.bounce.set(1);

	//createBlob(blob);

}

function update() {
	blobs.forEachExists(function checkOutofBounds(blob){
	if( blob.x -blob.width/2<=0 || blob.y-blob.height/2<=0 || blob.y+ blob.height/2>=game.world._height || blob.x +blob.width/2>= game.world._width){
		gameOver();
	}
	});

	$('#newGame').click(function(){
		alert("button clicked!");
		reset();
	});
}

function updateTime() {
	var score = ""+cSec/10;
	if(score.indexOf('.')<=0){
		score+=".0";
	}
	console.log(score);
	var highScore = $('#best').text();
	var startVal = highScore.search(/[0-9]+/);
	highScore = parseInt(highScore.substring(startVal));
	var s = "Score <br> " +score;
	$('#score').html(s);
	cSec+=1;
	if(highScore<score){
		$('#best').html("Best <br> "+score);
	}
}

function listener(blob) {
	//console.log("here");
	
	createBlob(blob);
	if(blob.scale.x>.1){
		createBlob(blob, blobs);
	}
	else{
		if(game.rnd.realInRange(0,1.5)>.5){
			createBlob(blob,blobs);
		}
	}

	blob.destroy();
}



function createBlob(oldBlob){
	var blob = blobs.create(oldBlob.x,oldBlob.y,'blob');
	//blob.setAnchor
	if(oldBlob.scale.x>.25){
		blob.scale.setTo(oldBlob.scale.x * .5,oldBlob.scale.y * .5);
	}
	else{
		blob.scale.setTo(.1, .1);
	}

	blob.anchor.setTo(0.5,null);
	blob.inputEnabled= true;
	blob.events.onInputDown.add(listener, this);

	game.physics.enable(blob, Phaser.Physics.ARCADE);
	//blob.body.collideWorldBounds=true;
	blob.body.bounce.set(1);

	blob.body.collideWorldBounds=true;

	var vx;
	var vy;

	do{
		vx = game.rnd.realInRange(-oldBlob.body.velocity.x*1.3, oldBlob.body.velocity.x*1.3);
		vy = game.rnd.realInRange(-oldBlob.body.velocity.y*1.3, oldBlob.body.velocity.y*1.3);
	}while(vx*vx+vy*vy<100)

	if(oldBlob.body.velocity.x*vx>0){
		vx=vx*-1;
	}
	if(oldBlob.body.velocity.y*vy>0){
		vy=vy*-1;
	}

	blob.body.velocity.setTo(vx, vy);

}



function gameOver(){
	blobs.forEachExists(function freeze(blob){
		blob.body.velocity.setTo(0,0);
		blob.events.onInputDown.removeAll();
		timer.stop();
	});
	bigText="Game Over!"
	bigStyle = { font: "65px Arial", fill: "#ffffff", align: "center" };

	game.add.text(game.world.centerX-170, 0, bigText, bigStyle);


}

</script>

</html>